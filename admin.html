<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin panel ‚Äì PP AUTO</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body { padding: 32px; background: var(--bg); color: var(--text); }
    .wrap { display: grid; grid-template-columns: 420px 1fr; gap: 24px; align-items: start; }
    form { display: grid; gap: 10px; background: var(--card); border:1px solid var(--line); border-radius: 16px; padding: 16px; }
    label { font-weight: 600; font-size: 13px; }
    input, select { padding: 10px; border-radius: 10px; border:1px solid var(--line); background: var(--bg-elev); color: var(--text); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .btnx { padding: 10px 14px; border-radius: 10px; border:1px solid var(--line); background: var(--bg-elev); color: var(--text); font-weight: 600; cursor: pointer; }
    .btnx.primary { background:#0044d6; border-color: transparent; color: #fff; }
    .btnx.danger { background:#8b0000; border-color: transparent; color: #fff; }
    .hint { color: var(--muted); font-size: 12px; margin-top: -6px; }
    .list { background: var(--card); border:1px solid var(--line); border-radius: 16px; padding: 12px; }
    .toolbar { display:flex; gap:8px; justify-content: space-between; align-items:center; margin-bottom: 8px; }
    .search { flex:1; }
    .search input { width:100%; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px 10px; border-bottom: 1px solid var(--line); font-size: 14px; }
    tr:hover { background: rgba(255,255,255,.02); }
    .cell-actions { display:flex; gap:6px; }
    .pill-mini { padding: 4px 8px; border:1px solid var(--line); border-radius: 999px; font-size: 12px; color: var(--muted); }
    .preview { border:1px dashed var(--line); border-radius: 12px; padding: 8px; display:grid; place-items:center; background: #0e141c; }
    .preview img { max-width: 100%; height: auto; display:block; border-radius: 8px; }
    @media (max-width: 1024px){ .wrap { grid-template-columns: 1fr; } }
    form .row{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  align-items: end;               /* spodky pol√≠ v jednom riadku */
}

/* ka≈æd√Ω field = label nad inputom + rovnak√© medzery */
form .row > div,
#povodnaCenaWrap,
#novaCenaWrap,
form > div:not(.row):not(.actions){
  display: flex;
  flex-direction: column;
  gap: 6px;
}

form label{ margin-bottom: 0; line-height: 1.2; }
form input:not([type="checkbox"]):not([type="file"]),
form select, form textarea{ width:100%; height:42px; }

form input[type="checkbox"]{ width:auto; height:auto; }


/* riadok s obr√°zkom: URL ≈°ir≈°√≠ ako upload */
/* riadok s obr√°zkom je 1 stƒ∫pec */
.row--image{ grid-template-columns: 1fr; }

/* zarovnaj file input doprava */
.upload-inline{
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 8px;
}

/* v√Ω≈°ka zhodn√° s ostatn√Ωmi poƒæami */
.upload-inline input[type="file"]{ height:42px; }

.upload-inline .btnx{ height:42px; }

/* mierna rezerva pod n√°hƒæad */
.preview{ margin-top: 8px; }
  </style>
</head>
<body>

  <h2>üõ†Ô∏è Admin panel ‚Äì spr√°va √°ut</h2>
  

  <div class="wrap">
    <!-- FORM -->
    <form id="carForm">
      <label><input type="checkbox" id="zlava"> Toto auto je v zƒæave</label>

      <div class="row">
        <div>
          <label>Znaƒçka</label>
          <input type="text" id="znacka" placeholder="Subaru" required/>
        </div>
        <div>
          <label>Model</label>
          <input type="text" id="model" placeholder="BRZ" required/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Rok</label>
          <input type="number" id="rok" placeholder="2024" required/>
        </div>
        <div>
          <label>Palivo</label>
          <input type="text" id="palivo" placeholder="Benz√≠n"/>
        </div>
      </div>

      <div>
        <label>Prevodovka / V√Ωbava</label>
        <input type="text" id="prevodovka" placeholder="AT ‚Ä¢ Premium"/>
      </div>

      <div id="povodnaCenaWrap">
        <label>P√¥vodn√° cena (alebo aktu√°lna, ak zƒæava NIE JE)</label>
        <input type="text" id="stara_cena" placeholder="43 840 ‚Ç¨"/>
      </div>

      <div id="novaCenaWrap" style="display:none">
        <label>Aktu√°lna cena po zƒæave</label>
        <input type="text" id="nova_cena" placeholder="39 900 ‚Ç¨"/>
        <div class="hint">Zobraz√≠ sa zelenou, ‚ÄûP√¥vodn√° cena‚Äú bude preƒçiarknut√°.</div>
      </div>

      <div>
  <label>Obr√°zok</label>
  <!-- skryt√© pole ‚Äì sem sa po odoslan√≠ ulo≈æ√≠ URL z uploadu -->
  <input type="hidden" id="obrazok" />

  <div class="row row--image">
    <div class="upload-inline">
      <input type="file" id="fileInput" accept="image/*" />
      <!-- tlaƒçidlo Nahra≈• sme odstr√°nili -->
    </div>
  </div>

  <div class="preview" id="imgPreview">
    <small class="hint">Vyber s√∫bor. Pri ‚ÄûOdosla≈•‚Äú sa automaticky nahr√° a ulo≈æ√≠.</small>
  </div>
</div>




      <div>
        <label>Tagy (ƒçiarkou oddelen√©)</label>
        <input type="text" id="tagy" placeholder="subaru, skladom"/>
      </div>

      <div class="actions">
        <button class="btnx primary" id="submitBtn" type="submit">Odosla≈•</button>
        <button class="btnx" type="button" id="resetBtn">Vyƒçisti≈• formul√°r</button>
        <button class="btnx danger" type="button" id="deleteBtn" style="display:none">Vymaza≈• vybran√©</button>
        
      </div>

      <!-- skryt√©: index upravovan√©ho z√°znamu -->
      <input type="hidden" id="editIndex" value="-1"/>
    </form>

    <!-- LIST -->
    <div class="list">
      <div class="toolbar">
        <div class="search"><input type="text" id="search" placeholder="Hƒæada≈• v ponuke‚Ä¶"></div>
        <div class="actions">
          <button class="btnx" id="exportBtn" type="button">Exportova≈• auta.json</button>
          <button class="btnx" id="reloadBtn" type="button">Naƒç√≠ta≈• zo s√∫boru</button>
        </div>
      </div>
      <table id="carsTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Znaƒçka</th>
            <th>Model</th>
            <th>Rok</th>
            <th>Cena</th>
            <th>Tagy</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody><!-- render --></tbody>
      </table>
    </div>
  </div>

  <script>
    // ====== STATE ======
    let cars = [];
    const form = document.getElementById('carForm');
    
    const editIndexInput = document.getElementById('editIndex');
    const submitBtn = document.getElementById('submitBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const zlava = document.getElementById('zlava');
    const povodnaCenaWrap = document.getElementById('povodnaCenaWrap');
    const novaCenaWrap = document.getElementById('novaCenaWrap');
    const imgInput = document.getElementById('obrazok');
    const imgPreview = document.getElementById('imgPreview');
    const tableBody = document.querySelector('#carsTable tbody');
    const searchInput = document.getElementById('search');

    // ====== INIT ======
    document.getElementById('reloadBtn').addEventListener('click', loadFromApi);

    document.getElementById('exportBtn').addEventListener('click', exportJSON);
    document.getElementById('resetBtn').addEventListener('click', () => setFormMode('create'));
    deleteBtn.addEventListener('click', onDeleteSelected);
    searchInput.addEventListener('input', renderTable);
    zlava.addEventListener('change', toggleZlavaUI);
  

    toggleZlavaUI();
    loadFromApi();

    // ====== UI HELPERS ======
    function toggleZlavaUI(){
      if (zlava.checked) {
        novaCenaWrap.style.display = 'block';
      } else {
        novaCenaWrap.style.display = 'none';
        form.nova_cena.value = '';
      }
    }

    function renderPreview(){
      const url = imgInput.value.trim();
      if (!url) {
        imgPreview.innerHTML = '<small class="hint">N√°hƒæad sa zobraz√≠ po vyplnen√≠ poƒæa.</small>';
        return;
      }
      imgPreview.innerHTML = '<img src="'+url+'" alt="n√°hƒæad obr√°zka">';
    }

    function setFormMode(mode, index = -1){
      if (mode === 'create') {
        form.reset();
        editIndexInput.value = -1;
        submitBtn.textContent = 'Odosla≈•';
        deleteBtn.style.display = 'none';
        
        zlava.checked = false;
        toggleZlavaUI();
        renderPreview();
      } else if (mode === 'edit') {
        editIndexInput.value = index;
        submitBtn.textContent = 'Ulo≈æi≈• zmeny';
        deleteBtn.style.display = 'inline-flex';
       
        toggleZlavaUI();
        renderPreview();
      }
    }

    // ====== DATA IO ======
    async function loadFromApi(){
  try {
    const res = await fetch('/api/cars', { cache: 'no-store' });
    if (!res.ok) throw new Error('GET /api/cars failed: ' + res.status);
    cars = await res.json();
    renderTable();
  } catch (e) {
    console.error('Nepodarilo sa naƒç√≠ta≈• /api/cars', e);
    cars = [];
    renderTable();
  }
}

// n√°hƒæad po v√Ωbere s√∫boru (pred odoslan√≠m)
const fileEl = document.getElementById('fileInput');
fileEl.addEventListener('change', () => {
  if (!fileEl.files || !fileEl.files[0]) {
    imgPreview.innerHTML = '<small class="hint">Vyber s√∫bor. Pri ‚ÄûOdosla≈•‚Äú sa automaticky nahr√° a ulo≈æ√≠.</small>';
    return;
  }
  const url = URL.createObjectURL(fileEl.files[0]);
  imgPreview.innerHTML = `<img src="${url}" alt="n√°hƒæad">`;
});


    function exportJSON(){
      const blob = new Blob([JSON.stringify(cars, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'auta.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ====== TABLE RENDER ======
    function renderTable(){
      const q = searchInput.value.trim().toLowerCase();
      tableBody.innerHTML = '';

      cars
        .map((c, i) => ({...c, _i: i}))
        .filter(c => {
          const hay = [c.znacka, c.model, c.rok, c.palivo, c.prevodovka, (c.tagy||[]).join(' ')].join(' ').toLowerCase();
          return !q || hay.includes(q);
        })
        .forEach((c, idx) => {
          const tr = document.createElement('tr');

          const cenaLabel = (c.nova_cena && String(c.nova_cena).trim() !== '')
            ? `${c.stara_cena || ''} ‚Üí ${c.nova_cena}`
            : (c.stara_cena || '‚Äî');

          tr.innerHTML = `
            <td>${c._i + 1}</td>
            <td>${c.znacka || ''}</td>
            <td>${c.model || ''}</td>
            <td>${c.rok || ''}</td>
            <td>${cenaLabel}</td>
            <td>${(c.tagy || []).join(', ')}</td>
            <td class="cell-actions">
              <button class="btnx" data-edit="${c._i}">Upravi≈•</button>
              <button class="btnx danger" data-del="${c._i}">Vymaza≈•</button>
            </td>
          `;
          tableBody.appendChild(tr);
        });

      // akcie
      tableBody.querySelectorAll('[data-edit]').forEach(btn => {
        btn.addEventListener('click', () => onEdit(parseInt(btn.dataset.edit, 10)));
      });
      tableBody.querySelectorAll('[data-del]').forEach(btn => {
        btn.addEventListener('click', () => onDelete(parseInt(btn.dataset.del, 10)));
      });
    }

    // ====== CRUD ======
    form.addEventListener('submit', async (e) => {
  e.preventDefault();

  // 1) pr√≠padn√Ω upload nov√©ho s√∫boru
  const fileEl = document.getElementById('fileInput');
  let imageUrl = form.obrazok.value.trim(); // existuj√∫ca URL pri edit√°cii

  if (fileEl.files && fileEl.files[0]) {
    if (fileEl.files[0].size > 10 * 1024 * 1024) {
      alert('S√∫bor je pr√≠li≈° veƒæk√Ω (max 10 MB).');
      return;
    }
    const base64 = await fileToBase64(fileEl.files[0]);
    const up = await fetch('/api/upload-image', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        filename: fileEl.files[0].name,
        contentBase64: base64
      })
    });
    if (!up.ok) {
      const t = await up.text();
      console.error('Upload failed:', t);
      alert('Nahratie obr√°zka zlyhalo.');
      return;
    }
    const upData = await up.json();
    imageUrl = upData.url || '';
    form.obrazok.value = imageUrl; // ulo≈æ√≠me aj do hidden inputu
  }

  // (voliteƒæn√©) vy≈æaduj obr√°zok pri vytv√°ran√≠ nov√©ho auta
  const idx = parseInt(editIndexInput.value, 10);
  const isEdit = Number.isInteger(idx) && idx >= 0;
  if (!isEdit && !imageUrl) {
    alert('Pros√≠m, vyber obr√°zok.');
    return;
  }

  // 2) d√°ta auta
  const maZlavu = zlava.checked;
  const data = {
    znacka: form.znacka.value.trim(),
    model: form.model.value.trim(),
    rok: Number(form.rok.value),
    palivo: form.palivo.value.trim(),
    prevodovka: form.prevodovka.value.trim(),
    stara_cena: (form.stara_cena.value || '').trim(),
    nova_cena: maZlavu ? (form.nova_cena.value || '').trim() : '',
    obrazok: imageUrl,
    tagy: form.tagy.value.split(',').map(t => t.trim()).filter(Boolean)
  };

  // 3) ulo≈æenie auta cez API
  if (isEdit) {
    await fetch(`/api/cars?index=${idx}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
  } else {
    await fetch('/api/cars', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
  }

  // 4) refresh + reset
  await loadFromApi();
  setFormMode('create');
});



    function onEdit(index){
      const a = cars[index];
      form.znacka.value = a.znacka || '';
      form.model.value = a.model || '';
      form.rok.value = a.rok || '';
      form.palivo.value = a.palivo || '';
      form.prevodovka.value = a.prevodovka || '';
      form.stara_cena.value = a.stara_cena || '';
      form.nova_cena.value = a.nova_cena || '';
      form.obrazok.value = a.obrazok || '';
      form.tagy.value = (a.tagy || []).join(', ');
      zlava.checked = !!(a.nova_cena && String(a.nova_cena).trim() !== '');
      toggleZlavaUI();
      renderPreview();
      setFormMode('edit', index);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function onDelete(index){
  if (!confirm('Naozaj vymaza≈• toto auto?')) return;
  await fetch(`/api/cars?index=${index}`, { method: 'DELETE' });
  await loadFromApi();
  setFormMode('create');
}


    function onDeleteSelected(){
      const idx = parseInt(editIndexInput.value, 10);
      if (!(Number.isInteger(idx) && idx >= 0)) return;
      onDelete(idx);
    }
  </script>
  <script>
  // premeni File na ƒçist√© base64 (bez data: prefixu)
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error('Nepodarilo sa naƒç√≠ta≈• s√∫bor.'));
      reader.onload = () => {
        const result = reader.result; // data:*;base64,xxxx
        const base64 = String(result).split(',')[1]; // odstr√°ni≈• "data:...;base64,"
        resolve(base64);
      };
      reader.readAsDataURL(file);
    });
  }

  
</script>

</body>
</html>
